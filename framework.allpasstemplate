float allpassTEMPLATE(float time, float f, float tL, float gain, int Ndelay)
{
    float threshold = 1e-3;

    float _TIME = time;
    float sum = -gain*INSTANCE;
    float fac = 1-gain*gain;

    int imax = 1 + int((log(threshold)-log(fac))/log(gain));
    
    for(int i = 0; i < imax; i++)
    {
        _TIME -= time - float(Ndelay)*Tsample;
        sum += fac*INSTANCE;
        fac *= gain;
    }
    return sum;
}
